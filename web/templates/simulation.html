{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">UAV Path Planning Simulation</h4>
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <select id="algorithm-select" class="form-select">
                                <option value="mcts">Monte Carlo Tree Search</option>
                                <option value="rrt">Rapidly-exploring Random Tree</option>
                            </select>
                        </div>
                        <button id="initialize-btn" class="btn btn-primary me-2">
                            <i class="bi bi-arrow-clockwise"></i> Initialize
                        </button>
                        <button id="step-btn" class="btn btn-secondary me-2" disabled>
                            <i class="bi bi-skip-forward"></i> Step
                        </button>
                        <button id="run-btn" class="btn btn-success" disabled>
                            <i class="bi bi-play-fill"></i> Run
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="simulation-container" class="text-center py-3">
                        <div id="loading-indicator" class="d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Running simulation...</p>
                        </div>
                        <div id="simulation-placeholder" class="bg-dark-subtle rounded-3 p-5">
                            <i class="bi bi-robot fs-1 mb-3 text-primary"></i>
                            <h5>Initialize the simulation to start</h5>
                            <p class="text-muted">Click the "Initialize" button to set up the environment and algorithm.</p>
                        </div>
                        <div id="simulation-content" class="d-none">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="plot-container mb-3">
                                        <img id="simulation-plot" src="" alt="Simulation Plot" class="img-fluid rounded">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-dark-subtle">
                                        <div class="card-header">
                                            <h5 class="mb-0">Simulation Status</h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="simulation-status">
                                                <p><strong>Algorithm:</strong> <span id="current-algorithm">-</span></p>
                                                <p><strong>Step:</strong> <span id="current-step">0</span>/<span id="max-steps">0</span></p>
                                                <p><strong>UAV Energy:</strong> <span id="uav-energy">0</span> J</p>
                                                <p><strong>Tasks Serviced:</strong> <span id="tasks-serviced">0</span></p>
                                                <p><strong>Data Processed:</strong> <span id="data-processed">0</span> MB</p>
                                                <p><strong>Flight Distance:</strong> <span id="flight-distance">0</span> m</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="results-container" class="d-none">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="plot-container">
                                    <h5 class="mb-2">UAV Trajectory</h5>
                                    <img id="trajectory-plot" src="" alt="Trajectory Plot" class="img-fluid rounded">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="plot-container">
                                    <h5 class="mb-2">Energy Consumption</h5>
                                    <img id="energy-plot" src="" alt="Energy Plot" class="img-fluid rounded">
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Performance Metrics</h5>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-bordered metrics-table">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Metric</th>
                                                    <th>Value</th>
                                                    <th>Description</th>
                                                </tr>
                                            </thead>
                                            <tbody id="metrics-table-body">
                                                <!-- Metrics will be added here dynamically -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <button id="back-btn" class="btn btn-secondary d-none">
                        <i class="bi bi-arrow-left"></i> Back to Simulation
                    </button>
                    <div>
                        <a href="/comparison" class="btn btn-info" id="compare-btn">
                            <i class="bi bi-bar-chart"></i> Compare Algorithms
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // State variables
        let currentAlgorithm = 'mcts';
        let simulationActive = false;
        let simulationComplete = false;
        
        // Initialize button
        $('#initialize-btn').click(function() {
            // Get selected algorithm
            currentAlgorithm = $('#algorithm-select').val();
            
            // Show loading indicator
            $('#loading-indicator').removeClass('d-none');
            $('#simulation-placeholder').addClass('d-none');
            
            // Initialize algorithm
            $.ajax({
                url: '/api/initialize/' + currentAlgorithm,
                method: 'POST',
                success: function(data) {
                    // Enable step and run buttons
                    $('#step-btn').prop('disabled', false);
                    $('#run-btn').prop('disabled', false);
                    
                    // Set algorithm name
                    $('#current-algorithm').text(currentAlgorithm.toUpperCase());
                    
                    // Hide loading indicator
                    $('#loading-indicator').addClass('d-none');
                    
                    // Show simulation content
                    $('#simulation-content').removeClass('d-none');
                    
                    // Set simulation active
                    simulationActive = true;
                    simulationComplete = false;
                    
                    // Reset results
                    $('#results-container').addClass('d-none');
                    $('#back-btn').addClass('d-none');
                },
                error: function(error) {
                    console.error('Error initializing algorithm:', error);
                    
                    // Hide loading indicator
                    $('#loading-indicator').addClass('d-none');
                    $('#simulation-placeholder').removeClass('d-none');
                    
                    // Show error alert
                    alert('Error initializing algorithm. Please try again.');
                }
            });
        });
        
        // Step button
        $('#step-btn').click(function() {
            if (!simulationActive) return;
            
            // Show loading indicator
            $('#loading-indicator').removeClass('d-none');
            $('#simulation-content').addClass('d-none');
            
            // Step algorithm
            $.ajax({
                url: '/api/step/' + currentAlgorithm,
                method: 'POST',
                success: function(data) {
                    // Hide loading indicator
                    $('#loading-indicator').addClass('d-none');
                    $('#simulation-content').removeClass('d-none');
                    
                    // Update simulation plot
                    $('#simulation-plot').attr('src', 'data:image/png;base64,' + data.plot);
                    
                    // Update status
                    updateStatus(data.state);
                    
                    // Check if done
                    if (data.done) {
                        simulationActive = false;
                        simulationComplete = true;
                        
                        // Disable step and run buttons
                        $('#step-btn').prop('disabled', true);
                        $('#run-btn').prop('disabled', true);
                        
                        // Run the algorithm to get final metrics
                        runAlgorithm();
                    }
                },
                error: function(error) {
                    console.error('Error stepping algorithm:', error);
                    
                    // Hide loading indicator
                    $('#loading-indicator').addClass('d-none');
                    $('#simulation-content').removeClass('d-none');
                    
                    // Show error alert
                    alert('Error stepping algorithm. Please try again.');
                }
            });
        });
        
        // Run button
        $('#run-btn').click(function() {
            if (!simulationActive) return;
            
            // Run the algorithm
            runAlgorithm();
        });
        
        // Back button
        $('#back-btn').click(function() {
            // Hide results and show simulation
            $('#results-container').addClass('d-none');
            $('#simulation-content').removeClass('d-none');
            $('#back-btn').addClass('d-none');
        });
        
        // Function to run algorithm to completion
        function runAlgorithm() {
            // Show loading indicator
            $('#loading-indicator').removeClass('d-none');
            $('#simulation-content').addClass('d-none');
            
            // Run algorithm
            $.ajax({
                url: '/api/run/' + currentAlgorithm,
                method: 'POST',
                success: function(data) {
                    // Hide loading indicator
                    $('#loading-indicator').addClass('d-none');
                    
                    // Update plots
                    $('#trajectory-plot').attr('src', 'data:image/png;base64,' + data.trajectory_plot);
                    $('#energy-plot').attr('src', 'data:image/png;base64,' + data.energy_plot);
                    
                    // Update metrics table
                    updateMetricsTable(data.metrics);
                    
                    // Show results
                    $('#results-container').removeClass('d-none');
                    $('#back-btn').removeClass('d-none');
                    
                    // Set simulation complete
                    simulationActive = false;
                    simulationComplete = true;
                    
                    // Disable step and run buttons
                    $('#step-btn').prop('disabled', true);
                    $('#run-btn').prop('disabled', true);
                },
                error: function(error) {
                    console.error('Error running algorithm:', error);
                    
                    // Hide loading indicator
                    $('#loading-indicator').addClass('d-none');
                    $('#simulation-content').removeClass('d-none');
                    
                    // Show error alert
                    alert('Error running algorithm. Please try again.');
                }
            });
        }
        
        // Function to update status
        function updateStatus(state) {
            $('#current-step').text(state.current_step || 0);
            $('#max-steps').text(3000);  // Default max steps
            $('#uav-energy').text((state.uav_energy || 0).toFixed(2));
            $('#tasks-serviced').text(state.serviced_tasks || 0);
            $('#data-processed').text((state.data_processed || 0).toFixed(2));
            $('#flight-distance').text((state.total_flight_distance || 0).toFixed(2));
        }
        
        // Function to update metrics table
        function updateMetricsTable(metrics) {
            const tableBody = $('#metrics-table-body');
            tableBody.empty();
            
            // Define metrics descriptions
            const descriptions = {
                'algorithm': 'The algorithm used for path planning',
                'serviced_tasks': 'Number of user tasks successfully serviced',
                'data_processed': 'Amount of data processed (in MB)',
                'total_flight_distance': 'Total distance traveled by the UAV (in m)',
                'energy_consumed': 'Total energy consumed by the UAV (in J)',
                'energy_efficiency': 'Data processed per unit of energy (in bits/J)',
                'avg_task_delay': 'Average delay between task arrival and service (in s)',
                'steps': 'Number of simulation steps'
            };
            
            // Add rows for each metric
            for (const [key, value] of Object.entries(metrics)) {
                if (key === 'trajectory' || key === 'energy_log' || key === 'stats_log') continue;
                
                const row = $('<tr>');
                const formattedValue = typeof value === 'number' ? value.toFixed(2) : value;
                
                row.append($('<td>').text(key));
                row.append($('<td>').text(formattedValue));
                row.append($('<td>').text(descriptions[key] || ''));
                
                tableBody.append(row);
            }
        }
        
        // Check URL parameters for algorithm selection
        const urlParams = new URLSearchParams(window.location.search);
        const algorithmParam = urlParams.get('algorithm');
        
        if (algorithmParam) {
            $('#algorithm-select').val(algorithmParam);
            currentAlgorithm = algorithmParam;
        }
    });
</script>
{% endblock %}